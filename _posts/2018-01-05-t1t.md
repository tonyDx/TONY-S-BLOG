---
layout: post
title:  "微信跳一跳hack源码解析以及商业化失败的反思"
date:   2018-01-05 23:45:13 -0400
background: '/img/posts/pub_48.jpg'
published : true
---

### 代码解析

代码放在[github](https://github.com/tonyDx/t1t/blob/master/pre.js)上面https://github.com/tonyDx/t1t/blob/master/pre.js;

这里简单说一下代码的主要逻辑;

首先跳一跳这个小游戏主要接口有四个

* wxagame_getuserinfo :用于获取用户信息;
* wxagame_getfriendsscore  :获取朋友的得分信息;
* wxagame_init :初始话游戏,类似于游戏开始;
* wxagame_settlement :分数超过历史最高分，也就是破纪录的时候会调用这个接口;

逻辑看代码，就是根据sessionId不断拿信息去进行下一个请求；

加密是用的AES和sessionId的前16位混合加密；


代码注释我写的比较详细；


### 如何抓包

* 下载最新 charlesproxy
* 启动 charlesproxy
* 配置代理： 设置 > 无线局域网 > 配置代理 > 手动 > IP：电脑 ip，端口： 8888
* 导入 https 证书： 浏览器访问 http://chls.pro/ssl 下载安装证书  (想要抓包https必须证书)
* 启动跳一跳小程序
* 去 charlesproxy 里查看抓到的请求, https://mp.weixin.qq.com/wxagame/ 开头的所有路径的请求，请求体里就包含 session_id

安卓用户也可以用Packet Capture很好用


###  商业化几点思考
话说码农在研究这些接口的漏洞的时候，
淘宝上面很多店家早已经挣的盆满钵满了，
当然淘宝卖家大部分不会用这种方法（卧底问了问）；
大部分用的技术就是python测量距离，然后模拟屏幕按压。
再次一点的就会用人工来代练。

但是这些方法有一个很大的弱点：
* 弱点一：
        因为用户就必须把自己的微信在卖家手机上登录。
这样一来站在卖家的角度来讲就相当于直接拒绝了至少50%的用户（也不能说绝对，可以考运营来解决），但是先天缺陷是绝对的。
* 弱点二：
        这两公方式花费时间很长，你刷个几百分还好（花几分钟），
如果用户需要刷2008，6666这些特殊数字，甚至几万分，那起码得花半小时以上（缺点二）

这两个弱点叠加起来就是用户会有一段时间用不上手机。

相反直接post分数则不会有这些问题，直接要多少分post过去就是了，基本花的时间就在抓包（sessionId）上面
本来找到post方法之后就可以商业化了，毕竟这一点解决上面方案的弱点二了。
不过纠结于怎么让用户更方便的抓包，没有实践，不过方案我终于找到了，不过现在这个游戏已经过气了，望各位引以为戒。


### 如果让用户无痛抓包

抓包这些是可以脚本来代替的：

大致说原理，我用自己的服务器架设一个代理服务器，用户连过来，然后安装我的证书，然后用脚本对代理服务器的流量进行截取并提取sessionId，之后保存到数据库，并记住用户的ip，
然后让用户访问一个输入自己想要的分数的页面，用户输入自己的分数，然后服务器根据ip拿到数据库中用户的sessionId，然后吧用户的分数post到微信的服务器就ok了，访问页面的过程中甚至可以加入付费的功能进行商业化。

恩，就这样，算是一个反思吧。




更新截止2018/10/26，微信应该已经换了跳一跳的安全验证了，不过我也没兴趣再研究了。